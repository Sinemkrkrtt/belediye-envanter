<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>M√ºd√ºrl√ºkler Arasƒ± Transfer</title>
  <style>
   body {
  max-width: 1300px;
  margin: 70px auto 30px;
  padding: 0 15px;
  font-family: 'Poppins', sans-serif;
  background: #f9fbfc;
  color: #333;
}

 header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: #f8f9fa; /* A√ßƒ±k gri ton */
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05); /* Hafif g√∂lge */
  padding: 0 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  z-index: 100;
  user-select: none;
  border-bottom: 1px solid #e0e0e0; /* ƒ∞nce alt √ßizgi */
}

  header h1 {
  margin: 0;
  font-weight: 700;
  font-size: 2.2rem;
  color: transparent;
  background: linear-gradient(90deg, #b31217, #e52d27); /* Kƒ±rmƒ±zƒ± tonlarda ge√ßi≈üli yazƒ± */
  -webkit-background-clip: text;
  background-clip: text;
  letter-spacing: 2.5px;
  font-family: 'Segoe UI', 'Poppins', sans-serif; /* Modern, ≈üƒ±k fontlar */
  user-select: none;
  flex-grow: 1;
  text-align: center;

}
form {
  margin-top: 90px;
  background: #f7f3f3;
  padding: 30px 32px;
  border-radius: 14px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
  display: flex;
  flex-direction: column;
  gap: 30px;
  transition: 0.3s ease;
}

.form-columns {
  display: flex;
  gap: 30px;
  flex-wrap: wrap;
}

.form-column {
  flex: 1;
  min-width: 250px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-column h3 {
  margin-bottom: 6px;
  font-size: 1rem;
  color: #444;
  font-weight: 600;
  border-bottom: 1px solid #eee;
  padding-bottom: 6px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  font-size: 0.88rem;
  margin-bottom: 6px;
  color: #555;
}

select,
input[type="text"],
input[type="number"] {
  padding: 10px 14px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 0.9rem;
  background: #fdfdfd;
  transition: 0.2s ease-in-out;
}

select:focus,
input:focus {
  outline: none;
  border-color: #888;
  background: #fff;
  box-shadow: 0 0 0 2px rgba(179, 18, 23, 0.1);
}

button {
  align-self: flex-end;
  padding: 10px 28px;
  background: #b31217;
  color: #fff;
  font-weight: 500;
  font-size: 1rem;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
}

button:hover {
  background: #9c0f14;
  box-shadow: 0 2px 10px rgba(179, 18, 23, 0.15);
}

.container h2 {
  text-align: center;
  color: #b31217;
  margin-bottom: 20px;
}

table thead {
  background: #eee;
}


 .container {
    width:98vw; /* T√ºm ekran geni≈üliƒüi */
    margin-left: calc(-50vw + 50%);
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.05);
  }

 table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
    table-layout: fixed;
    word-wrap: break-word;
  }

  table th, table td {
    border: 1px solid #ddd;
    padding: 10px 12px;
    text-align: left;
    font-size: 0.95rem;
  }


th {
  background: #f9f9f9;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 0.8rem;
  color: #666;
}

tbody tr:hover {
  background: #f6f6f6;
}

@media (max-width: 768px) {
  .form-columns {
    flex-direction: column;
  }

  button {
    align-self: stretch;
  }
}

  </style>
</head>
<body>
  <header>
    <h1>M√ºd√ºrl√ºkler Arasƒ± Transfer</h1>
  </header>
<form id="transferForm">
  <div class="form-columns">
    
    <!-- Sol S√ºtun: √úr√ºn Bilgisi -->
    <div class="form-column">
      <h3>√úr√ºn Bilgisi</h3>
      <div class="form-group">
        <label>T√ºr</label>
        <select id="productType" required>
          <option value="" disabled selected>Se√ßin</option>
          <option value="monitor">Monit√∂r</option>
          <option value="keyboard">Klavye</option>
          <option value="mouse">Mouse</option>
        </select>
      </div>
      <div class="form-group">
        <label>Marka</label>
        <select id="brand" disabled required>
          <option value="" disabled selected>Se√ßin</option>
        </select>
      </div>
      <div class="form-group">
        <label>Model</label>
        <select id="model" disabled required>
          <option value="" disabled selected>Se√ßin</option>
        </select>
      </div>
      <div class="form-group">
        <label>IP</label>
        <input type="text" id="ip" placeholder="IP Adresi " />
      </div>
    </div>

    <!-- Orta S√ºtun: G√∂nderen Bilgileri -->
    <div class="form-column">
      <h3>G√∂nderen</h3>
      <div class="form-group">
        <label>M√ºd√ºrl√ºk</label>
        <select id="fromDepartment" disabled required></select>
      </div>
      <div class="form-group">
        <label>≈ûeflik</label>
        <select id="fromBranch" disabled required></select>
      </div>
      <div class="form-group">
        <label>Ki≈üi</label>
        <select id="fromPerson" disabled required></select>
      </div>
    </div>

    <!-- Saƒü S√ºtun: Alƒ±cƒ± Bilgileri -->
    <div class="form-column">
      <h3>Alƒ±cƒ±</h3>
      <div class="form-group">
        <label>M√ºd√ºrl√ºk</label>
        <select id="toDepartment" disabled required></select>
      </div>
      <div class="form-group">
        <label>≈ûeflik</label>
        <select id="toBranch" disabled required></select>
      </div>
      <div class="form-group">
        <label>Ki≈üi</label>
        <select id="toPerson" disabled required></select>
      </div>
    </div>

  </div>

  <button type="submit">Transfer Et</button>
</form>

 <div class="container">
<h2>M√ºd√ºrl√ºkler Arasƒ± Transferler</h2>

  <table>
   <thead>
  <tr>
    <th>Tarih</th>
    <th>G√∂nderen M√ºd√ºrl√ºk</th>
    <th>G√∂nderen ≈ûeflik</th>
    <th>G√∂nderen Ki≈üi</th>
    <th>Alƒ±cƒ± M√ºd√ºrl√ºk</th>
    <th>Alƒ±cƒ± ≈ûeflik</th>
    <th>Alƒ±cƒ± Ki≈üi</th>
    <th>√úr√ºn</th>
    <th>IP</th>
  </tr>
</thead>

    <tbody id="transferTableBody">
      <tr><td colspan="6">Y√ºkleniyor...</td></tr>
    </tbody>
  </table>


 <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
 
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      Timestamp,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase yapƒ±landƒ±rma
    const firebaseConfig = {
      apiKey: "AIzaSyC6G7JfaTCSpvwkX4PXTTJ6I92LIpzkkxk",
      authDomain: "belediyeenvanter.firebaseapp.com",
      projectId: "belediyeenvanter",
      storageBucket: "belediyeenvanter.appspot.com",
      messagingSenderId: "1088833874170",
      appId: "1:1088833874170:web:2c2c1c069a9880917b8143"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // √úr√ºn verisi (T√ºr ‚Üí Marka ‚Üí Model)
    const productData = {
      monitor: {
        Samsung: ["S24F350", "U28E590", "C27F398"],
        LG: ["24MK600M", "27GL650F", "32QN600"],
        Dell: ["P2419H", "U2719D", "S2721QS"]
      },
      keyboard: {
        Logitech: ["K120", "K380", "MX Keys"],
        Microsoft: ["Ergonomic", "Bluetooth Keyboard"],
        Corsair: ["K70", "K95", "K68"]
      },
      mouse: {
        Logitech: ["MX Master 3", "G502 Hero", "M185"],
        Razer: ["DeathAdder", "Basilisk", "Naga"],
        Microsoft: ["Classic IntelliMouse", "Arc Mouse"]
      }
    };

    // DOM elemanlarƒ±
    const productTypeSelect = document.getElementById("productType");
    const brandSelect = document.getElementById("brand");
    const modelSelect = document.getElementById("model");
    const ipInput = document.getElementById("ip");

    const fromDepartmentSelect = document.getElementById("fromDepartment");
    const fromBranchSelect = document.getElementById("fromBranch");
    const fromPersonSelect = document.getElementById("fromPerson");

    const toDepartmentSelect = document.getElementById("toDepartment");
    const toBranchSelect = document.getElementById("toBranch");
    const toPersonSelect = document.getElementById("toPerson");

    const transferForm = document.getElementById("transferForm");
    const transferTableBody = document.getElementById("transferTableBody");

    // Personel verisi tutacak
    const personData = [];

    // √úr√ºn t√ºr√ºne g√∂re marka ve model doldur
    productTypeSelect.addEventListener("change", () => {
      const selectedType = productTypeSelect.value;

      brandSelect.innerHTML = `<option value="" disabled selected>Marka Se√ßin</option>`;
      modelSelect.innerHTML = `<option value="" disabled selected>Model Se√ßin</option>`;
      modelSelect.disabled = true;

      if (selectedType && productData[selectedType]) {
        Object.keys(productData[selectedType]).forEach(brand => {
          const option = document.createElement("option");
          option.value = brand;
          option.textContent = brand;
          brandSelect.appendChild(option);
        });
        brandSelect.disabled = false;
      } else {
        brandSelect.disabled = true;
        modelSelect.disabled = true;
      }
    });

    // Marka se√ßilince modelleri doldur
    brandSelect.addEventListener("change", () => {
      const selectedType = productTypeSelect.value;
      const selectedBrand = brandSelect.value;

      modelSelect.innerHTML = `<option value="" disabled selected>Model Se√ßin</option>`;

      if (selectedType && selectedBrand && productData[selectedType][selectedBrand]) {
        productData[selectedType][selectedBrand].forEach(model => {
          const option = document.createElement("option");
          option.value = model;
          option.textContent = model;
          modelSelect.appendChild(option);
        });
        modelSelect.disabled = false;
      } else {
        modelSelect.disabled = true;
      }
    });

    // Personel verisini Firebase'den √ßek ve dropdownlarƒ± doldur
    async function loadPersonData() {
      personData.length = 0; // √∂nce temizle
      fromDepartmentSelect.innerHTML = `<option value="" disabled selected>M√ºd√ºrl√ºk</option>`;
      toDepartmentSelect.innerHTML = `<option value="" disabled selected>M√ºd√ºrl√ºk</option>`;

      const snapshot = await getDocs(collection(db, "personeller"));
      snapshot.forEach(doc => {
        const data = doc.data();
        personData.push({
          name: data.isimSoyisim,
          department: data.mudurluk,
          branch: data.seflik
        });
      });

      // M√ºd√ºrl√ºkleri e≈üsiz olarak √ßek
      const departments = [...new Set(personData.map(p => p.department))];
      departments.forEach(dep => {
        const option1 = document.createElement("option");
        option1.value = dep;
        option1.textContent = dep;
        fromDepartmentSelect.appendChild(option1);

        const option2 = document.createElement("option");
        option2.value = dep;
        option2.textContent = dep;
        toDepartmentSelect.appendChild(option2);
      });

      fromDepartmentSelect.disabled = false;
      toDepartmentSelect.disabled = false;
      fromBranchSelect.disabled = true;
      toBranchSelect.disabled = true;
      fromPersonSelect.disabled = true;
      toPersonSelect.disabled = true;
    }

    // M√ºd√ºrl√ºk deƒüi≈üince ≈üeflikleri getir (G√∂nderen)
    fromDepartmentSelect.addEventListener("change", () => {
      const selectedDep = fromDepartmentSelect.value;

      const branches = [...new Set(personData.filter(p => p.department === selectedDep).map(p => p.branch))];

      fromBranchSelect.innerHTML = `<option value="" disabled selected>≈ûeflik Se√ßin</option>`;
      fromPersonSelect.innerHTML = `<option value="" disabled selected>Ki≈üi Se√ßin</option>`;
      fromPersonSelect.disabled = true;

      branches.forEach(branch => {
        const option = document.createElement("option");
        option.value = branch;
        option.textContent = branch;
        fromBranchSelect.appendChild(option);
      });

      fromBranchSelect.disabled = false;
    });

    // ≈ûeflik deƒüi≈üince ki≈üileri getir (G√∂nderen)
    fromBranchSelect.addEventListener("change", () => {
      const selectedDep = fromDepartmentSelect.value;
      const selectedBranch = fromBranchSelect.value;

      const people = personData.filter(p => p.department === selectedDep && p.branch === selectedBranch).map(p => p.name);

      fromPersonSelect.innerHTML = `<option value="" disabled selected>Ki≈üi Se√ßin</option>`;
      people.forEach(person => {
        const option = document.createElement("option");
        option.value = person;
        option.textContent = person;
        fromPersonSelect.appendChild(option);
      });

      fromPersonSelect.disabled = false;
    });

    // M√ºd√ºrl√ºk deƒüi≈üince ≈üeflikleri getir (Alƒ±cƒ±)
    toDepartmentSelect.addEventListener("change", () => {
      const selectedDep = toDepartmentSelect.value;

      const branches = [...new Set(personData.filter(p => p.department === selectedDep).map(p => p.branch))];

      toBranchSelect.innerHTML = `<option value="" disabled selected>≈ûeflik Se√ßin</option>`;
      toPersonSelect.innerHTML = `<option value="" disabled selected>Ki≈üi Se√ßin</option>`;
      toPersonSelect.disabled = true;

      branches.forEach(branch => {
        const option = document.createElement("option");
        option.value = branch;
        option.textContent = branch;
        toBranchSelect.appendChild(option);
      });

      toBranchSelect.disabled = false;
    });

    // ≈ûeflik deƒüi≈üince ki≈üileri getir (Alƒ±cƒ±)
    toBranchSelect.addEventListener("change", () => {
      const selectedDep = toDepartmentSelect.value;
      const selectedBranch = toBranchSelect.value;

      const people = personData.filter(p => p.department === selectedDep && p.branch === selectedBranch).map(p => p.name);

      toPersonSelect.innerHTML = `<option value="" disabled selected>Ki≈üi Se√ßin</option>`;
      people.forEach(person => {
        const option = document.createElement("option");
        option.value = person;
        option.textContent = person;
        toPersonSelect.appendChild(option);
      });

      toPersonSelect.disabled = false;
    });

    // Firestore'dan transfer ge√ßmi≈üini listele
    async function listeleHareketler() {
  transferTableBody.innerHTML = `<tr><td colspan="6">Y√ºkleniyor...</td></tr>`;

  const hareketlerCol = collection(db, "hareketler");
  const q = query(hareketlerCol, orderBy("date", "desc"));
  const snapshot = await getDocs(q);

  if (snapshot.empty) {
    transferTableBody.innerHTML = `<tr><td colspan="6">Kayƒ±t bulunamadƒ±.</td></tr>`;
    return;
  }

  transferTableBody.innerHTML = "";

  snapshot.forEach(doc => {
    const data = doc.data();

    // Aynƒ± m√ºd√ºrl√ºkten aynƒ± m√ºd√ºrl√ºƒüe olan transferleri atla
    if (data.fromDepartment === data.toDepartment) return;

    const tarih = data.date?.toDate().toLocaleString("tr-TR") || "-";
    const productName = data.productName || "-";

   const row = document.createElement("tr");
row.innerHTML = `
  <td>${tarih}</td>
  <td>${data.fromDepartment || "-"}</td>
  <td>${data.fromBranch || "-"}</td>
  <td>${data.fromPerson || "-"}</td>
  <td>${data.toDepartment || "-"}</td>
  <td>${data.toBranch || "-"}</td>
  <td>${data.toPerson || "-"}</td>
  <td>${productName}</td>
  <td>${data.ip || "-"}</td>
`;
transferTableBody.appendChild(row);

  });
}

    // Stok kontrol fonksiyonu (√∂rnek, koleksiyonda productName ve quantity var varsayalƒ±m)
   function normalize(str) {
  return str.toLowerCase().replace(/\s+/g, "").trim();
}
async function checkStock(productName, quantity) {
  const stokRef = collection(db, "hareketler");
  const snapshot = await getDocs(stokRef);

  let totalStock = 0;

  snapshot.forEach(doc => {
    const data = doc.data();
    if (data.productName === productName) {
      totalStock += data.quantity;
    }
  });

  console.log("Toplam stok:", totalStock, "ƒ∞stenen:", quantity);
  return totalStock >= quantity;
}


    // Form g√∂nderim i≈ülemi
    transferForm.addEventListener("submit", async e => {
      e.preventDefault();

      const productType = productTypeSelect.value;
      const brand = brandSelect.value;
      const model = modelSelect.value;
      const ip = ipInput.value.trim() || "-";
const quantity = 1;

      const fromDepartment = fromDepartmentSelect.value;
      const fromBranch = fromBranchSelect.value;
      const fromPerson = fromPersonSelect.value;

      const toDepartment = toDepartmentSelect.value;
      const toBranch = toBranchSelect.value;
      const toPerson = toPersonSelect.value;
      

      if (!productType || !brand || !model || !fromDepartment || !fromBranch || !fromPerson || !toDepartment || !toBranch || !toPerson || !quantity) {
        alert("L√ºtfen t√ºm alanlarƒ± eksiksiz doldurun!");
        return;
      }

      const productName = `${productType} - ${brand} - ${model}`;
      

      // Stok kontrol (dilersen bu kƒ±smƒ± yorumlayabilirsin)
      const stokVarMi = await checkStock(productName, quantity);
    

      try {
      
       await addDoc(collection(db, "hareketler"), {
  date: Timestamp.now(),
  fromDepartment,
  fromBranch,
  fromPerson,
  toDepartment,
  toBranch,
  toPerson,
  product: productType,
  brand,
  model,
  ip,
  quantity,
  productName  // Bunu EKLEYƒ∞N!
});


            // üîÑ Stok g√ºncelle
            await updateStock(fromDepartment, productName, -quantity); // d√º≈ü
            await updateStock(toDepartment, productName, quantity);   // ekle

        alert("√úr√ºn ba≈üarƒ±yla g√∂nderildi!");
        transferForm.reset();

        brandSelect.disabled = true;
        modelSelect.disabled = true;
        fromBranchSelect.disabled = true;
        fromPersonSelect.disabled = true;
        toBranchSelect.disabled = true;
        toPersonSelect.disabled = true;

        // M√ºd√ºrl√ºk dropdownlarƒ± sƒ±fƒ±rla ama a√ßƒ±k kalsƒ±n
        fromDepartmentSelect.selectedIndex = 0;
        toDepartmentSelect.selectedIndex = 0;

        // Tabloyu g√ºncelle
            listeleHareketler();
        } catch (error) {
        console.error("G√∂nderim hatasƒ±:", error);
        alert("G√∂nderim sƒ±rasƒ±nda hata olu≈ütu.");
        }
    });
    async function updateStock(department, productName, change) {
  const stokRef = collection(db, "stoklar");
  const snapshot = await getDocs(stokRef);

  let stokDoc = null;
  let stokId = null;

  // Stok varsa bul
  snapshot.forEach(doc => {
    const data = doc.data();
    if (
      normalize(data.productName) === normalize(productName) &&
      normalize(data.department) === normalize(department)
    ) {
      stokDoc = data;
      stokId = doc.id;
    }
  });

  if (stokDoc) {
    // G√ºncelle
    const newQty = (stokDoc.quantity || 0) + change;
    await setDoc(doc(db, "stoklar", stokId), {
      ...stokDoc,
      quantity: newQty < 0 ? 0 : newQty
    });
  } else {
    // Yeni stok olu≈ütur
    await addDoc(stokRef, {
  department,
  product: productType,
  brand: brand,
  model: model,
  productName,
  quantity: change < 0 ? 0 : change
});

  }
}
    // Sayfa a√ßƒ±lƒ±r a√ßƒ±lmaz personel verisini y√ºkle ve listeyi g√∂ster
    await loadPersonData();
    await listeleHareketler();
  </script>
</body>
</html>